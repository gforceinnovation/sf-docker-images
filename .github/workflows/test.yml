name: Test on Pull Request

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  test:
    name: Test Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Make test scripts executable
        run: chmod +x tests/*.sh
      
      - name: Run all tests
        run: ./tests/run-all-tests.sh
      
      - name: Check image sizes
        run: |
          echo "## Docker Image Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
          
          DEVCONTAINER_SIZE=$(docker image inspect sf-devcontainer:test --format='{{.Size}}')
          CI_SIZE=$(docker image inspect sf-ci:test --format='{{.Size}}')
          
          echo "| sf-devcontainer | $(numfmt --to=iec-i --suffix=B $DEVCONTAINER_SIZE) |" >> $GITHUB_STEP_SUMMARY
          echo "| sf-ci | $(numfmt --to=iec-i --suffix=B $CI_SIZE) |" >> $GITHUB_STEP_SUMMARY
